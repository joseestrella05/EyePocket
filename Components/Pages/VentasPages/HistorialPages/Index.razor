@page "/Ventas/Historial"
@using System.Globalization
@inject OrdenVentaService ordenVentaService
@inject OrdenVentasDetalleService ordenVentaDetalleService
@inject NavigationManager navigationManager

<PageTitle>Historial</PageTitle>

<div class="card-header text-center py-2 rounded-3" style="background-color: #004b55; color: white;">
    <h3 class="mb-0 font-weight-bold" style="font-weight: bold;">Historial</h3>
</div>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-auto">
            <div class="card  border-0 rounded-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center text-md-end mb-3 mb-md-0">
                            <label class="d-inline-block fs-4 fw-bold text-black">
                                Buscar
                            </label>
                        </div>
                        <!-- Filtro -->
                        <div class="col-md-4 d-flex align-items-center mb-3 mb-md-0">
                            <label for="Filtro" class="form-label fw-bold me-3">Filtrar:</label>
                            <select @bind="filtro" class="form-select form-select-lg">
                                <option value="factura">Factura</option>
                                <option value="fecha">Fecha</option>
                                <option value="cliente">Cliente</option>
                            </select>
                        </div>

                        <!-- Barra de BÃºsqueda -->
                        <div class="col-md-5 col-12 d-flex align-items-center mb-3 mb-md-0">
                            <label for="ValorFiltro" class="form-label fw-bold me-3"></label>
                            <div class="input-group input-group-lg w-100">
                                <input @bind="valorFiltro" class="form-control" placeholder="Buscar..." />
                                <button @onclick="Buscar" class="btn btn-primary" type="button">
                                    <span class="bi bi-search"></span> Buscar
                                </button>
                            </div>
                            <!-- Restablecer -->
                            <div class="col-md-2 d-flex align-items-center  ms-3">
                                <button type="button" class="btn btn-outline-secondary d-flex align-items-center gap-2" @onclick="Restablecer">
                                    <span class="bi bi-arrow-counterclockwise"></span>
                                </button>
                            </div>
                        </div>


                        <!-- FiltroFecha - Mostrar solo si se selecciona "fecha" en el filtro -->
                        @if (filtro == "fecha")
                        {
                            <div class="row mt-3">
                                <!-- Desde -->
                                <div class="col-3">
                                    <label class="col-form-label"><strong>Desde</strong></label>
                                    <InputDate class="form-control" @bind-Value="Desde"></InputDate>
                                </div>

                                <!-- Hasta -->
                                <div class="col-3">
                                    <label class="col-form-label"><strong>Hasta</strong></label>
                                    <div class="input-group">
                                        <InputDate class="form-control" @bind-Value="Hasta"></InputDate>
                                    </div>
                                </div>
                            </div>
                        }


                    </div>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- Tabla -->
<table class="table table-striped table-hover table-bordered text-center align-middle">
    <thead class="bg-dark">
        <tr>
            <th>Factura</th>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Total Pagado</th>
            <th>Detalle</th>
        </tr>
    </thead>

    <tbody>
        @foreach (var venta in ListaOrdenVenta)
        {
            <tr>
                <td>@venta.NumeroFactura</td>
                <td>@venta.FechaEmision.ToString("dd/MM/yyyy")</td>
                <td>@venta.Clientes?.Nombre</td>
                <td>@venta.MontoTotal.ToString("C", CultureInfo.CreateSpecificCulture("en-US"))</td>
                <td>
                    <button class="btn btn-warning btn-sm" @onclick="() => MostrarModalDetalleHistorial(venta)">
                        <span class="bi bi-eye"></span>Detalle
                    </button>
                </td>
            </tr>

        }
    </tbody>
</table>
<style>
    .form-group {
        display: inline-block;
        margin-right: 7px;
    }

        .form-group label {
            display: inline-block;
            margin-right: 2.5px;
        }

        .form-group input {
            width: 100px;
        }

    .table thead.bg-dark th {
        color: black;
    }
</style>
@*   <div class="card-footer text-start">
    <p>Total de Contacto: @ListaContacto.Count</p>
</div>
<div style="height: 415px;"></div> *@

@if (mostrarModalFactura && ordenSeleccionada != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #004b55; color: white;">
                    <h5 class="modal-title">Historial @ordenSeleccionada.NumeroFactura</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModalDetalleHistorial"></button>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="fw-bold">Factura:</label>
                                <p>@ordenSeleccionada.NumeroFactura</p>
                            </div>
                            <div class="col-6">
                                <label class="fw-bold">Fecha:</label>
                                <p>@ordenSeleccionada.FechaEmision.ToString("dd/MM/yyyy")</p>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="fw-bold">Cliente:</label>
                                <p>@ordenSeleccionada.Clientes?.Nombre</p>
                            </div>
                            <div class="col-6">
                                <label class="fw-bold">Total a Pagar:</label>
                                <p>@ordenSeleccionada.MontoTotal.ToString("C", CultureInfo.CreateSpecificCulture("en-US"))</p>
                            </div>

                            <div class="col-6">
                                <label class="fw-bold">Cantidad: </label>
                                <p>@ordenVentaDetalle.Cantidad</p>
                            </div>

                            <div class="col-6">
                                <label class="fw-bold">RNC: </label>
                                <p>@ordenSeleccionada.RNC</p>
                            </div>
                        </div>

                        <div class="col-12 d-flex justify-content-left mt-3">
                            <button class="btn btn-danger bi bi-arrow-left-circle" @onclick="CerrarModalDetalleHistorial">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    public OrdenVentaDetalle ordenVentaDetalle { get; set; } = new OrdenVentaDetalle();
    public OrdenVenta ordenventa { get; set; }
    public List<OrdenVenta> ListaOrdenVenta { get; set; } = new List<OrdenVenta>();
    private string valorFiltro = "";
    private string filtro = "id";
    public DateTime? Desde { get; set; }
    public DateTime? Hasta { get; set; }

    public OrdenVenta ordenSeleccionada { get; set; } = new OrdenVenta();

    private bool mostrarModalFactura = false;

    protected override async Task OnInitializedAsync()
    {
        ListaOrdenVenta = await ordenVentaService.Listar(u => true);
    }

    private void MostrarModalDetalleHistorial(OrdenVenta orden)
    {
        ordenSeleccionada = orden;
        mostrarModalFactura = true;
    }

    private void CerrarModalDetalleHistorial()
    {
        ordenSeleccionada = new OrdenVenta();
        mostrarModalFactura = false;
    }

    public async Task Buscar()
    {
        // if (!string.IsNullOrWhiteSpace(valorFiltro))
        // {
        //    if (filtro == "fecha" && DateTime.TryParse(valorFiltro, out DateTime fecha))
        // {
        //     ListaEvento = await eventosService.Listar(t => t.fecha == fecha);
        // }
        //
        // }
        // else if (filtro == "fecha" && Desde.HasValue && Hasta.HasValue)
        //    {
        //        ListaEvento = await eventosService.Listar(t => t.fecha >= Desde.Value && t.fecha <= Hasta.Value);
        //    }
        // else
        // {
        //     ListaContacto = await contactoService.Listar(u => true);
        // }
    }
    public void Volver()
    {
        navigationManager.NavigateTo("/");
    }

    private async Task Restablecer()
    {
        // ListaContacto = await contactoService.Listar(t => t.contactoId > 0);
        // filtro = string.Empty;
        // valorFiltro = string.Empty;
        Desde = null;
        Hasta = null;
    }


}