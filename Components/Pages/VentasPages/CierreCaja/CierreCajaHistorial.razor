@page "/Ventas/CierreCajaHistorial"
@using System.Globalization
@inject CierreCajaService cierreCajaService
@inject NavigationManager navigationManager

<PageTitle>Historial Cierre de caja</PageTitle>

<div class="card-header text-center py-2 rounded-3" style="background-color: #004b55; color: white;">
    <h3 class="mb-0 font-weight-bold" style="font-weight: bold;">Historial Cierre de caja</h3>
</div>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-auto">
            <div class="card border-0 rounded-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center text-md-end mb-3 mb-md-0">
                            <label class="d-inline-block fs-4 fw-bold text-black">
                                Filtrar por Fecha
                            </label>
                        </div>

                        <!-- Filtro de Fecha -->
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label fw-bold">Desde:</label>
                            <InputDate class="form-control form-control-lg" @bind-Value="Desde" />
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label fw-bold">Hasta:</label>
                            <InputDate class="form-control form-control-lg" @bind-Value="Hasta" />
                        </div>

                        <!-- Botones -->
                        <div class="col-md-3 d-flex align-items-end gap-2">
                            <button @onclick="Buscar" class="btn btn-primary btn-lg w-100">
                                <span class="bi bi-search"></span> Buscar
                            </button>
                            <button @onclick="Restablecer" class="btn btn-outline-secondary btn-lg">
                                <span class="bi bi-arrow-counterclockwise"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla -->
<table class="table table-striped table-hover table-bordered text-center align-middle">
    <thead class="bg-dark">
        <tr>
            <th>Id</th>
            <th>Fecha</th>
            <th>Monto Apertura</th>
            <th>Cantidad de ventas</th>
            <th>Monto de ventas</th>
            <th>Monto de cierre</th>
            <th>Detalle</th>
        </tr>
    </thead>

    <tbody>
        @foreach (var historial in ListaCierreCaja)
        {
            <tr>
                <td>@historial.CierreId</td>
                <td>@historial.Fecha.ToString("dd/MM/yyyy")</td>
                <td>@historial.MontoApertura.ToString("C", CultureInfo.CreateSpecificCulture("en-US"))</td>
                <td>@historial.CantidadDeVentas</td>
                <td>@historial.MontoDeVentas.ToString("C", CultureInfo.CreateSpecificCulture("en-US"))</td>
                <td>@historial.MontoDeCierre.ToString("C", CultureInfo.CreateSpecificCulture("en-US"))</td>
                <td>
                    <button class="btn btn-warning btn-sm" @onclick="() => DetalleHistorial(historial)">
                        <span class="bi bi-eye"></span> Detalle
                    </button>
                </td>

            </tr>
        }
    </tbody>
</table>

<style>
    .form-group {
        display: inline-block;
        margin-right: 7px;
    }

        .form-group label {
            display: inline-block;
            margin-right: 2.5px;
        }

        .form-group input {
            width: 100px;
        }

    .table thead.bg-dark th {
        color: black;
    }
</style>

@if (mostrarModalCierre)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #004b55;">
                    <h5 class="modal-title fw-bold text-white">Detalle del Cierre de Caja</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModalCierre"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <h4 class="fw-bold">Cierre del día <strong>@cierreSeleccionado.Fecha.ToString("dd/MM/yyyy")</strong></h4>
                    </div>

                    <table class="table table-bordered text-center">
                        <tr>
                            <th>ID Cierre</th>
                            <td>@cierreSeleccionado.CierreId</td>
                        </tr>
                        <tr>
                            <th>Monto de Apertura</th>
                            <td>@cierreSeleccionado.MontoApertura.ToString("C", CultureInfo.CreateSpecificCulture("en-US"))</td>
                        </tr>
                        <tr>
                            <th>Monto de Ventas</th>
                            <td>@cierreSeleccionado.MontoDeVentas.ToString("C", CultureInfo.CreateSpecificCulture("en-US"))</td>
                        </tr>
                        <tr>
                            <th>Cantidad de Ventas</th>
                            <td>@cierreSeleccionado.CantidadDeVentas</td>
                        </tr>
                        <tr>
                            <th>Monto de Cierre</th>
                            <td class="fw-bold">@cierreSeleccionado.MontoDeCierre.ToString("C", CultureInfo.CreateSpecificCulture("en-US"))</td>
                        </tr>
                    </table>
                </div>
                <div class="modal-footer d-flex justify-content-end">
                    <button class="btn btn-secondary" @onclick="CerrarModalCierre">
                        <i class="bi bi-x-circle"></i> Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    public CierreCaja cierreCaja { get; set; } = new CierreCaja();
    public List<CierreCaja> ListaCierreCaja { get; set; } = new List<CierreCaja>();
    private string valorFiltro = "";
    private string filtro = "id";
    public DateTime? Desde { get; set; }
    public DateTime? Hasta { get; set; }
    private bool mostrarModalCierre = false;
    private CierreCaja cierreSeleccionado = new CierreCaja();

    protected override async Task OnInitializedAsync()
    {
        ListaCierreCaja = await cierreCajaService.Listar(c => true);
    }

    private void DetalleHistorial(CierreCaja cierre)
    {
        cierreSeleccionado = cierre;
        mostrarModalCierre = true;
    }

    private void CerrarModalCierre()
    {
        cierreSeleccionado = new CierreCaja();
        mostrarModalCierre = false;
    }

    public async Task Buscar()
    {

        if (filtro == "fecha" && Desde.HasValue && Hasta.HasValue)
        {
            ListaCierreCaja = await cierreCajaService.Listar(
                c => c.Fecha >= Desde.Value && c.Fecha <= Hasta.Value
            );
        }

        else if (!string.IsNullOrWhiteSpace(valorFiltro))
        {
            ListaCierreCaja = await cierreCajaService.Listar(
                c => c.CierreId.ToString().Contains(valorFiltro)
            );
        }

        else
        {
            ListaCierreCaja = await cierreCajaService.Listar(c => true);
        }
    }

    private async Task Restablecer()
    {
        filtro = "id";
        valorFiltro = string.Empty;
        Desde = null;
        Hasta = null;

        ListaCierreCaja = await cierreCajaService.Listar(c => true);
    }
}