@page "/Ventas/CierreCaja"
@using EyePocket.Models
@inject ToastService toastService
@inject NavigationManager NavigationManager
@inject CierreCajaService cierreCajaService
@inject OrdenVentaService ordenVentaService

<PageTitle>Cierre de Caja</PageTitle>

<EditForm Model="cierreCaja" OnValidSubmit="GuardarCierre">
    <DataAnnotationsValidator />
    <div class="cierre-container">
        <h3 class="cierre-titulo">Cierre de caja</h3>
        <p class="cierre-fecha">Fecha: @cierreCaja.Fecha.ToString("dd/MM/yyyy")</p>

        <div class="cierre-field">
            <label>Apertura</label><br />
            <input type="number" class="form-control" value="@cierreCaja.MontoApertura" readonly />
        </div>

        <div class="cierre-field">
            <label>Ingresos (Monto total de ventas del día)</label><br />
            <input type="number" class="form-control" value="@cierreCaja.MontoDeVentas" readonly />
        </div>

        <div class="cierre-field">
            <label>Cantidad de ventas</label><br />
            <input type="number" class="form-control" value="@cierreCaja.CantidadDeVentas" readonly />
        </div>

        <div class="cierre-field">
            <label>Monto de cierre (Apertura + Ingresos)</label><br />
            <input type="number" class="form-control" value="@cierreCaja.MontoDeCierre" readonly />
        </div>

        <div class="boton-centrado"><button class="btn btn-primary" type="submit">Guardar</button></div>
    </div>
</EditForm>

<style>
    .cierre-container {
        background-color: #004750;
        padding: 2rem;
        border-radius: 20px;
        max-width: 800px;
        margin: 3rem auto 0 auto;
        color: white;
    }

    .cierre-titulo {
        text-align: center;
        margin-bottom: 1rem;
    }

    .cierre-fecha {
        text-align: right;
        margin-bottom: 2rem;
    }

    .cierre-field {
        margin-bottom: 1.5rem;
    }

    .form-control {
        width: 100%;
        padding: 0.5rem;
        border-radius: 5px;
        border: none;
    }

    .boton-centrado {
        text-align: center;
        margin-top: 1.5rem;
    }

        .boton-centrado .btn {
            padding: 0.5rem 1.5rem;
            border-radius: 5px;
        }
</style>

@code {
    public CierreCaja cierreCaja { get; set; } = new CierreCaja();
    public List<OrdenVenta> ListaOrdenVentas { get; set; } = new();
    private bool cierreYaHecho = false;

    protected override async Task OnInitializedAsync()
    {
        var hoy = DateTime.Today;

        cierreYaHecho = await cierreCajaService.ExisteCierreDeHoy();

        if (cierreYaHecho)
        {
            MostrarToast(ToastType.Danger, "Cierre ya realizado", "Ya se ha realizado el cierre de caja para hoy.");
            return;
        }

        ListaOrdenVentas = await ordenVentaService.Listar(o => o.FechaEmision.Date == hoy);

        cierreCaja.Fecha = hoy;
        cierreCaja.MontoApertura = 5000;
        cierreCaja.CantidadDeVentas = ListaOrdenVentas.Count;
        cierreCaja.MontoDeVentas = ListaOrdenVentas.Sum(o => o.MontoTotal);
        cierreCaja.MontoDeCierre = cierreCaja.MontoApertura + cierreCaja.MontoDeVentas;
    }

    private async Task GuardarCierre()
    {
        if (cierreYaHecho)
        {
            MostrarToast(ToastType.Danger, "Cierre ya registrado", "Ya existe un cierre de caja para hoy.");
            return;
        }

        cierreCaja.MontoDeCierre = cierreCaja.MontoApertura + cierreCaja.MontoDeVentas;

        var guardado = await cierreCajaService.Guardar(cierreCaja);

        if (guardado)
        {
            MostrarToast(ToastType.Success, "Cierre exitoso", "El cierre de caja se ha realizado correctamente.");
            NavigationManager.NavigateTo("/Ventas/CierreCaja", forceLoad: true);
        }
        else
        {
            MostrarToast(ToastType.Warning, "Atención", "No se pudo realizar el cierre de caja");
        }
    }

    public void MostrarToast(ToastType tipo, string titulo, string cuerpo) =>
        toastService.Notify(new(tipo, titulo, cuerpo));
}

